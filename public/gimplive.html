<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì—…ë¹„íŠ¸ vs ë°”ì´ë‚¸ìŠ¤ ê¹€ì¹˜í”„ë¦¬ë¯¸ì—„</title>
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      background-color: #f8f8f8;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 4px;
    }
    #update-time {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    table {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
    }
    th {
      background-color: #f0f0f0;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>ì—…ë¹„íŠ¸ vs ë°”ì´ë‚¸ìŠ¤ ê¹€ì¹˜í”„ë¦¬ë¯¸ì—„</h1>
  <div id="update-time">â³ ì—…ë°ì´íŠ¸ ì¤‘...</div>
  <table>
    <thead>
      <tr>
        <th>ì½”ì¸</th>
        <th>ì—…ë¹„íŠ¸ (KRW)</th>
        <th>ë°”ì´ë‚¸ìŠ¤ (USD)</th>
        <th>í™˜ìœ¨ (KRW)</th>
        <th>ë°”ì´ë‚¸ìŠ¤ (KRW í™˜ì‚°)</th>
        <th>ê¹€í”„ (%)</th>
      </tr>
    </thead>
    <tbody id="price-table"></tbody>
  </table>

  <script>
    const coins = ["BTC", "ETH", "XRP", "ADA", "SOL", "DOGE", "TRX", "DOT", "AVAX", "BCH", "LINK", "LTC", "MATIC", "ETC", "XLM", "SAND", "EOS", "APT", "ATOM", "NEAR", "AAVE", "STX", "IMX", "ZIL", "WAVES", "CHZ", "FTM", "ARPA", "RUNE", "GALA"];
    const fetchInterval = 300; // ì´ˆ ë‹¨ìœ„

    async function fetchExchangeRate() {
      const res = await fetch("/.netlify/functions/exchangeRate");
      const json = await res.json();
      return json.usdToKrw;
    }

    async function fetchPrices() {
      const res = await fetch("/.netlify/functions/prices");
      return await res.json();
    }

    function formatKRW(value) {
      return Number(value).toLocaleString("ko-KR") + " KRW";
    }

    function formatUSD(value) {
      return Number(value).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " USD";
    }

    function formatPremium(p) {
      return (p > 0 ? "+" : "") + p.toFixed(2) + " %";
    }

    async function updateTable() {
      try {
        const [exchangeRate, prices] = await Promise.all([
          fetchExchangeRate(),
          fetchPrices()
        ]);

        const table = document.getElementById("price-table");
        table.innerHTML = "";

        let now = new Date();
        document.getElementById("update-time").innerText =
          `ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.toLocaleString()} (âŸ³ ${fetchInterval}ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸ë¨)`;

        coins.forEach(symbol => {
          const upbit = prices.upbit[symbol];
          const binance = prices.binance[symbol];

          if (!upbit || !binance) return; // ë°ì´í„° ì—†ëŠ” ê²½ìš° í‘œì‹œ ì•ˆí•¨

          const priceUpbit = upbit.trade_price;
          const priceBinance = binance;
          const binanceKRW = priceBinance * exchangeRate;
          const premium = ((priceUpbit - binanceKRW) / binanceKRW) * 100;

          const row = `
            <tr>
              <td>${symbol}</td>
              <td>${formatKRW(priceUpbit)}</td>
              <td>${formatUSD(priceBinance)}</td>
              <td>${formatKRW(exchangeRate)}</td>
              <td>${formatKRW(binanceKRW)}</td>
              <td>${formatPremium(premium)}</td>
            </tr>
          `;
          table.insertAdjacentHTML("beforeend", row);
        });
      } catch (e) {
        document.getElementById("update-time").innerText = "âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨";
        console.error(e);
      }
    }

    updateTable();
    setInterval(updateTable, fetchInterval * 1000);
  </script>
</body>
</html>
