<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>업비트 vs 바이낸스 김치프리미엄</title>
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      background-color: #f8f8f8;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 4px;
    }
    #update-time {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    table {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
    }
    th {
      background-color: #f0f0f0;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>업비트 vs 바이낸스 김치프리미엄</h1>
  <div id="update-time">⏳ 업데이트 중...</div>
  <table>
    <thead>
      <tr>
        <th>코인</th>
        <th>업비트 (KRW)</th>
        <th>바이낸스 (USD)</th>
        <th>환율 (KRW)</th>
        <th>바이낸스 (KRW 환산)</th>
        <th>김프 (%)</th>
      </tr>
    </thead>
    <tbody id="price-table"></tbody>
  </table>

  <script>
    const coins = ["BTC", "ETH", "XRP", "ADA", "SOL", "DOGE", "TRX", "DOT", "AVAX", "BCH", "LINK", "LTC", "MATIC", "ETC", "XLM", "SAND", "EOS", "APT", "ATOM", "NEAR", "AAVE", "STX", "IMX", "ZIL", "WAVES", "CHZ", "FTM", "ARPA", "RUNE", "GALA"];
    const fetchInterval = 300; // 초 단위

    async function fetchExchangeRate() {
      const res = await fetch("/.netlify/functions/exchangeRate");
      const json = await res.json();
      return json.usdToKrw;
    }

    async function fetchPrices() {
      const res = await fetch("/.netlify/functions/prices");
      return await res.json();
    }

    function formatKRW(value) {
      return Number(value).toLocaleString("ko-KR") + " KRW";
    }

    function formatUSD(value) {
      return Number(value).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " USD";
    }

    function formatPremium(p) {
      return (p > 0 ? "+" : "") + p.toFixed(2) + " %";
    }

    async function updateTable() {
      try {
        const [exchangeRate, prices] = await Promise.all([
          fetchExchangeRate(),
          fetchPrices()
        ]);

        const table = document.getElementById("price-table");
        table.innerHTML = "";

        let now = new Date();
        document.getElementById("update-time").innerText =
          `📅 마지막 업데이트: ${now.toLocaleString()} (⟳ ${fetchInterval}초마다 자동 업데이트됨)`;

        coins.forEach(symbol => {
          const upbit = prices.upbit[symbol];
          const binance = prices.binance[symbol];

          if (!upbit || !binance) return; // 데이터 없는 경우 표시 안함

          const priceUpbit = upbit.trade_price;
          const priceBinance = binance;
          const binanceKRW = priceBinance * exchangeRate;
          const premium = ((priceUpbit - binanceKRW) / binanceKRW) * 100;

          const row = `
            <tr>
              <td>${symbol}</td>
              <td>${formatKRW(priceUpbit)}</td>
              <td>${formatUSD(priceBinance)}</td>
              <td>${formatKRW(exchangeRate)}</td>
              <td>${formatKRW(binanceKRW)}</td>
              <td>${formatPremium(premium)}</td>
            </tr>
          `;
          table.insertAdjacentHTML("beforeend", row);
        });
      } catch (e) {
        document.getElementById("update-time").innerText = "❌ 데이터 로딩 실패";
        console.error(e);
      }
    }

    updateTable();
    setInterval(updateTable, fetchInterval * 1000);
  </script>
</body>
</html>
