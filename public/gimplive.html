<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>김치프리미엄 계산기 - 업비트 vs 바이낸스</title>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 40px 10px;
      text-align: center;
    }
    h2 {
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>💱 업비트 vs 바이낸스 김치프리미엄</h2>
  <table>
    <thead>
      <tr>
        <th>코인</th>
        <th>업비트 (KRW)</th>
        <th>바이낸스 (USD)</th>
        <th>환율 (KRW)</th>
        <th>바이낸스 (KRW 환산)</th>
        <th>김프 (%)</th>
      </tr>
    </thead>
    <tbody id="priceTable"></tbody>
  </table>

  <script>
    const coins = ["BTC", "ETH", "XRP", "ADA", "SOL", "DOGE", "DOT", "TRX", "AVAX", "MATIC", "LINK", "BCH", "LTC", "NEAR", "ATOM", "SAND", "AXS", "CHZ", "APT", "ETC", "EOS", "STX", "XLM", "IMX", "WAVES", "AAVE", "1INCH", "FLOW", "ZIL", "ALGO"];

    async function fetchExchangeRate() {
      try {
        const res = await fetch("/.netlify/functions/exchangeRate");
        const data = await res.json();
        return data.usdToKrw;
      } catch {
        return null;
      }
    }

    async function fetchPrice(exchange, symbol) {
      const urls = {
        upbit: `https://corsproxy.io/?https://api.upbit.com/v1/ticker?markets=KRW-${symbol}`,
        binance: `https://api.binance.com/api/v3/ticker/price?symbol=${symbol}USDT`
      };
      try {
        const res = await fetch(urls[exchange]);
        const json = await res.json();
        return exchange === 'upbit' ? json[0].trade_price : parseFloat(json.price);
      } catch {
        return null;
      }
    }

    async function updateTable() {
      const table = document.getElementById("priceTable");
      const exchangeRate = await fetchExchangeRate();

      for (const coin of coins) {
        const row = document.createElement("tr");

        const upbitPrice = await fetchPrice("upbit", coin);
        const binancePrice = await fetchPrice("binance", coin);
        const binanceToKRW = exchangeRate && binancePrice ? binancePrice * exchangeRate : null;
        const kimchi = (upbitPrice && binanceToKRW) ? (((upbitPrice - binanceToKRW) / binanceToKRW) * 100).toFixed(2) : null;

        row.innerHTML = `
          <td>${coin}</td>
          <td>${upbitPrice ? upbitPrice.toLocaleString()} KRW : ''}</td>
          <td>${binancePrice ? binancePrice.toLocaleString()} USD : ''}</td>
          <td>${exchangeRate ? exchangeRate.toLocaleString() + ' KRW' : '<span class="error">환율 오류</span>'}</td>
          <td>${binanceToKRW ? binanceToKRW.toLocaleString() + ' KRW' : '<span class="error">환산 실패</span>'}</td>
          <td>${kimchi ? kimchi + ' %' : '<span class="error">계산 오류</span>'}</td>
        `;

        table.appendChild(row);
      }
    }

    updateTable();
  </script>
</body>
</html>
